/**
 * Mixins
 * Reusable SCSS mixins for Aqua-style effects
 */

/**
 * Aqua Glass Effect (consolidated)
 * Creates the signature Mac OS X Aqua glossy appearance with:
 * - Top highlight/shine (::before pseudo-element)
 * - Bottom glow reflection (::after pseudo-element)
 *
 * Core presets:
 *   'round'  - Circular/spherical elements
 *   'box'    - Rectangular controls and buttons
 *   'bar'    - Flat/full-width bars and headers
 *
 * Modifier aliases:
 *   'subtle' - Lighter shine-only effect
 *
 * Backwards-compatible aliases are supported (e.g. 'circle', 'pill', 'header', ...).
 */

@use "sass:map";
@use "sass:meta";

/* ============================================
   Era/Theme helpers
   ============================================ */

@mixin aqua-era($era) {
  .aqua-era-#{$era},
  [data-aqua-era="#{$era}"] {
    @content;
  }
}

@mixin aqua-theme($theme) {
  .theme-#{$theme},
  [data-aqua-theme="#{$theme}"] {
    @content;
  }
}

/* ============================================
   Presets + aliases (single source of truth)
   ============================================ */

$aqua-glass-presets: (
  'round': (
    shine: (
      height: 40%,
      width: 75%,
      top: 8%,
      blur: 0.5px,
      opacity-start: 0.8,
      opacity-end: 0.15,
      radius: 50% 50% 30% 30%,
      z-index: 2
    ),
    glow: (
      height: 35%,
      width: 70%,
      bottom: 10%,
      blur: 1px,
      opacity-start: 0.1,
      opacity-end: 0.35,
      radius: 30% 30% 50% 50%,
      z-index: null
    )
  ),
  'box': (
    shine: (
      height: 33%,
      width: 90%,
      top: 5%,
      blur: 1px,
      opacity-start: 0.9,
      opacity-end: 0.3,
      radius: inherit,
      z-index: 1
    ),
    glow: (
      height: 33%,
      width: 90%,
      bottom: 10%,
      blur: 3px,
      opacity-start: 0.2,
      opacity-end: 0.5,
      radius: inherit,
      z-index: 1
    )
  ),
  'bar': (
    shine: (
      height: 50%,
      width: 100%,
      top: 0,
      blur: 0,
      opacity-start: 0.4,
      opacity-end: 0.05,
      radius: 0,
      z-index: 1
    ),
    glow: (
      height: 30%,
      width: 100%,
      bottom: 0,
      blur: 0,
      opacity-start: 0,
      opacity-end: 0.2,
      radius: 0,
      z-index: 1
    )
  )
);

// Aliases can define:
// - preset: base preset name ('round' | 'box' | 'bar')
// - options: default options for the alias
// - overrides: per-layer overrides merged into the base preset config
$aqua-glass-aliases: (
  // Modifiers
  'subtle': (
    preset: 'box',
    options: (parts: 'shine', glow: false, intensity: 0.85)
  ),

  // Legacy preset names (mapped to the consolidated presets)
  'circle': (preset: 'round'),
  'control-round': (preset: 'round'),
  'slider-thumb': (preset: 'round'),
  'switch': (preset: 'round'),
  'spinner': (preset: 'round'),

  'pill': (
    preset: 'box',
    overrides: (
      shine: (
        width: calc(100% - 0.875em),
        radius: 2em 2em 0.5em 0.5em,
        z-index: 2
      ),
      glow: (
        width: calc(100% - 1.25em),
        radius: 0.75em,
        z-index: null
      )
    )
  ),
  'bubble': (preset: 'box'),
  'tab': (preset: 'box'),
  'control': (preset: 'box'),
  'stepper': (preset: 'box'),
  'select': (preset: 'box'),

  'header': (preset: 'bar'),
  'progress': (preset: 'bar'),

  // Legacy "shine-only" names
  'toast': (preset: 'box', options: (parts: 'shine', glow: false, intensity: 1.25)),
  'menubar': (
    preset: 'bar',
    options: (parts: 'shine', glow: false, intensity: 0.85),
    overrides: (shine: (opacity-start: 0.3, opacity-end: 0.1))
  )
);

/* ============================================
   Internal helpers
   ============================================ */

@function _aqua-glass-option($options, $key, $fallback) {
  @if meta.type-of($options) == 'map' and map.has-key($options, $key) {
    @return map.get($options, $key);
  }
  @return $fallback;
}

@function _aqua-glass-scale-alpha($alpha, $intensity) {
  @if $alpha == null {
    @return null;
  }

  $scaled: $alpha * $intensity;
  @if $scaled < 0 {
    @return 0;
  }
  @if $scaled > 1 {
    @return 1;
  }
  @return $scaled;
}

@function _aqua-glass-width($layer) {
  @if meta.type-of($layer) == 'map' and map.has-key($layer, width) {
    @return map.get($layer, width);
  }

  @if meta.type-of($layer) == 'map' and map.has-key($layer, inset-x) {
    $inset-x: map.get($layer, inset-x);
    @return calc(100% - #{2 * $inset-x});
  }

  @return 100%;
}

@function _aqua-map-deep-merge($base, $overrides) {
  $merged: $base;

  @if meta.type-of($overrides) != 'map' {
    @return $merged;
  }

  @each $key, $value in $overrides {
    $existing: null;
    @if meta.type-of($base) == 'map' and map.has-key($base, $key) {
      $existing: map.get($base, $key);
    }

    @if meta.type-of($existing) == 'map' and meta.type-of($value) == 'map' {
      $merged: map.merge($merged, ($key: _aqua-map-deep-merge($existing, $value)));
    } @else {
      $merged: map.merge($merged, ($key: $value));
    }
  }

  @return $merged;
}

@function _aqua-glass-resolve($name) {
  @if map.has-key($aqua-glass-presets, $name) {
    @return (preset: $name);
  }

  @if map.has-key($aqua-glass-aliases, $name) {
    @return map.get($aqua-glass-aliases, $name);
  }

  @warn "Unknown aqua glass preset `#{$name}`; falling back to `round`.";
  @return (preset: 'round');
}

/* ============================================
   Public API
   ============================================ */

// parts: 'both' | 'shine' | 'glow'
@mixin aqua-glass($preset: 'round', $parts: null, $intensity: null, $glow: null, $overrides: ()) {
  $resolved: _aqua-glass-resolve($preset);

  $base-preset: map.get($resolved, preset);
  $base-config: map.get($aqua-glass-presets, $base-preset);

  @if $base-config == null {
    @warn "Unknown aqua glass base preset `#{$base-preset}`; falling back to `round`.";
    $base-config: map.get($aqua-glass-presets, 'round');
  }

  $alias-options: null;
  @if map.has-key($resolved, options) {
    $alias-options: map.get($resolved, options);
  }

  $alias-overrides: ();
  @if map.has-key($resolved, overrides) {
    $alias-overrides: map.get($resolved, overrides);
  }

  $final-parts: _aqua-glass-option($alias-options, parts, 'both');
  @if $parts != null {
    $final-parts: $parts;
  }

  $final-intensity: _aqua-glass-option($alias-options, intensity, 1);
  @if $intensity != null {
    $final-intensity: $intensity;
  }

  $final-glow: _aqua-glass-option($alias-options, glow, true);
  @if $glow != null {
    $final-glow: $glow;
  }

  $config: _aqua-map-deep-merge($base-config, $alias-overrides);
  $config: _aqua-map-deep-merge($config, $overrides);

  $shine: map.get($config, shine);
  $glow-layer: map.get($config, glow);

  $include-shine: $final-parts == 'both' or $final-parts == 'shine';
  $include-glow: $final-glow == true and ($final-parts == 'both' or $final-parts == 'glow');

  @if $include-shine and $shine != null {
    $shine-blur: map.get($shine, blur);
    $shine-z: map.get($shine, z-index);
    $shine-opacity-start: _aqua-glass-scale-alpha(map.get($shine, opacity-start), $final-intensity);
    $shine-opacity-end: _aqua-glass-scale-alpha(map.get($shine, opacity-end), $final-intensity);

    &::before {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      height: map.get($shine, height);
      width: _aqua-glass-width($shine);
      top: map.get($shine, top);
      background: linear-gradient(
        rgba(255, 255, 255, $shine-opacity-start),
        rgba(255, 255, 255, $shine-opacity-end)
      );
      border-radius: map.get($shine, radius);
      @if $shine-blur != null and $shine-blur != 0 {
        filter: blur($shine-blur);
      }
      @if $shine-z != null {
        z-index: $shine-z;
      }
      pointer-events: none;
    }
  }

  @if $include-glow and $glow-layer != null {
    $glow-blur: map.get($glow-layer, blur);
    $glow-z: map.get($glow-layer, z-index);
    $glow-opacity-start: _aqua-glass-scale-alpha(map.get($glow-layer, opacity-start), $final-intensity);
    $glow-opacity-end: _aqua-glass-scale-alpha(map.get($glow-layer, opacity-end), $final-intensity);

    &::after {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      height: map.get($glow-layer, height);
      width: _aqua-glass-width($glow-layer);
      bottom: map.get($glow-layer, bottom);
      background: linear-gradient(
        rgba(255, 255, 255, $glow-opacity-start),
        rgba(255, 255, 255, $glow-opacity-end)
      );
      border-radius: map.get($glow-layer, radius);
      @if $glow-blur != null and $glow-blur != 0 {
        filter: blur($glow-blur);
      }
      @if $glow-z != null {
        z-index: $glow-z;
      }
      pointer-events: none;
    }
  }
}

/* ============================================
   Backwards-compatible wrappers
   ============================================ */

@mixin aqua-glass-effect($shape: 'circle') {
  @include aqua-glass($shape);
}

@mixin aqua-glass-shine($shape: 'circle') {
  @include aqua-glass($shape, $parts: 'shine', $glow: false);
}

@mixin aqua-glass-glow($shape: 'circle') {
  @include aqua-glass($shape, $parts: 'glow', $glow: true);
}

@mixin aqua-table-base(
  $header-padding: 0 10px,
  $cell-padding: 0 10px,
  $header-border-right: 1px solid var(--table-header-border-right),
  $cell-border: 1px solid var(--table-cell-border),
  $header-glass: true
) {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid;
  border-color: var(--table-border);
  font-family: var(--font-ui);
  font-size: var(--font-size-base);

  th {
    background: var(--table-header-gradient);
    padding: $header-padding;
    text-align: left;
    font-weight: normal;
    border-bottom: 0.5px solid var(--table-header-border-bottom);
    border-right: $header-border-right;
    height: 22px;
    position: relative;

    @if $header-glass {
      @include aqua-glass('bar');
    }

    &:last-child {
      border-right: none;
    }
  }

  td {
    padding: $cell-padding;
    border-bottom: $cell-border;
    height: 22px;
  }

  th .sort-arrow {
    display: inline-block;
    width: 0;
    height: 0;
    margin-left: 4px;
    vertical-align: middle;

    &.asc {
      border-left: 3.5px solid transparent;
      border-right: 3.5px solid transparent;
      border-bottom: 4px solid var(--table-sort-arrow);
    }

    &.desc {
      border-left: 3.5px solid transparent;
      border-right: 3.5px solid transparent;
      border-top: 4px solid var(--table-sort-arrow);
    }
  }

  &.unified-header,
  &.aqua-unified-header {
    border-top: none;
    border-left: none;
    border-right: none;

    thead {
      position: relative;
      background: var(--aqua-button-secondary-gradient);
      box-shadow: var(--aqua-button-secondary-shadow-inset);
      border-radius: 0;
      overflow: hidden;

      @include aqua-glass('pill', $overrides: (
        shine: (
          width: calc(100% - 0.25em),
          height: 45%,
          radius: 0,
          z-index: 10
        ),
        glow: (
          width: calc(100% - 0.5em),
          radius: 0,
          z-index: 10
        )
      ));

      th {
        background: transparent;
        border-bottom: none;
        border-right: 1px solid var(--segmented-divider);
        color: var(--aqua-button-secondary-text);
        text-shadow: var(--aqua-button-secondary-text-shadow);
        position: relative;
        z-index: 1;
        cursor: pointer;

        &::before,
        &::after {
          display: none;
        }

        &:last-child {
          border-right: none;
        }

        &:hover:not(.active):not(.sorted):not([aria-sort]) {
          background: transparent;
        }

        &.active,
        &.sorted,
        &[aria-sort] {
          background: var(--aqua-button-primary-gradient);
          color: var(--aqua-button-primary-text);
          text-shadow: var(--aqua-button-primary-text-shadow);

          &:hover {
            background: var(--aqua-button-primary-gradient);
          }

          .sort-arrow {
            &.asc {
              border-bottom-color: var(--aqua-button-primary-text);
            }
            &.desc {
              border-top-color: var(--aqua-button-primary-text);
            }
          }
        }

        &:active {
          background: var(--aqua-button-primary-gradient);
          color: var(--aqua-button-primary-text);
          text-shadow: var(--aqua-button-primary-text-shadow);
        }

        .sort-arrow {
          position: absolute;
          right: 8px;
          top: 50%;
          transform: translateY(-50%);
          z-index: 11;
        }
      }
    }
  }
}
