<script>
    (function () {
      function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
      }

      function setupTitledPanes() {
        document.querySelectorAll('.aqua-titled-pane-header').forEach((header) => {
          header.addEventListener('click', () => {
            const pane = header.closest('.aqua-titled-pane');
            if (pane) pane.classList.toggle('expanded');
          });

          header.addEventListener('keydown', (event) => {
            if (event.key !== 'Enter' && event.key !== ' ') return;
            event.preventDefault();
            const pane = header.closest('.aqua-titled-pane');
            if (pane) pane.classList.toggle('expanded');
          });
        });
      }

      function setupTreeTable() {
        const roots = document.querySelectorAll('[data-tree-table]');
        if (!roots.length) return;

        roots.forEach((root) => {
          function toggleRows(parentId, expanded) {
            root.querySelectorAll(`tr[data-parent="${parentId}"]`).forEach((row) => {
              row.style.display = expanded ? '' : 'none';
            });
          }

          root.querySelectorAll('.aqua-tree-table-arrow[data-toggle]').forEach((arrow) => {
            const parentId = arrow.getAttribute('data-toggle');
            if (!parentId) return;

            toggleRows(parentId, arrow.classList.contains('expanded'));

            const activate = () => {
              arrow.classList.toggle('expanded');
              toggleRows(parentId, arrow.classList.contains('expanded'));
            };

            arrow.addEventListener('click', (event) => {
              event.preventDefault();
              activate();
            });

            arrow.addEventListener('keydown', (event) => {
              if (event.key !== 'Enter' && event.key !== ' ') return;
              event.preventDefault();
              activate();
            });
          });

          root.querySelectorAll('thead th').forEach((th) => {
            th.addEventListener('click', function() {
              const thead = this.closest('thead');
              const allThs = thead.querySelectorAll('th');

              allThs.forEach(header => {
                header.classList.remove('active');
                const arrow = header.querySelector('.sort-arrow');
                if (arrow) {
                  arrow.classList.remove('asc', 'desc');
                }
              });

              this.classList.add('active');

              let arrow = this.querySelector('.sort-arrow');
              if (!arrow) {
                arrow = document.createElement('span');
                arrow.className = 'sort-arrow';
                this.appendChild(arrow);
              }

              if (this.dataset.sortDir === 'asc') {
                arrow.classList.add('desc');
                this.dataset.sortDir = 'desc';
              } else {
                arrow.classList.add('asc');
                this.dataset.sortDir = 'asc';
              }
            });
          });
        });
      }

      function setupSplitPanes() {
        document.querySelectorAll('.aqua-split-divider[data-split]').forEach((divider) => {
          divider.addEventListener('pointerdown', (event) => {
            const splitId = divider.getAttribute('data-split');
            if (!splitId) return;
            const container = document.getElementById(splitId);
            if (!container) return;

            const isVertical = container.classList.contains('vertical');
            const prevPane = divider.previousElementSibling;
            const nextPane = divider.nextElementSibling;
            if (!prevPane || !nextPane) return;

            event.preventDefault();
            divider.setPointerCapture(event.pointerId);

            const containerRect = container.getBoundingClientRect();
            const dividerRect = divider.getBoundingClientRect();

            const dividerSize = isVertical ? dividerRect.height : dividerRect.width;
            const minSize = 60;
            const maxSize = (isVertical ? containerRect.height : containerRect.width) - dividerSize - minSize;

            const startPos = isVertical ? event.clientY : event.clientX;
            const startPrevSize = isVertical ? prevPane.getBoundingClientRect().height : prevPane.getBoundingClientRect().width;

            function onMove(moveEvent) {
              const currentPos = isVertical ? moveEvent.clientY : moveEvent.clientX;
              const delta = currentPos - startPos;
              const nextPrevSize = clamp(startPrevSize + delta, minSize, maxSize);

              if (isVertical) {
                prevPane.style.height = `${nextPrevSize}px`;
                prevPane.style.flex = `0 0 ${nextPrevSize}px`;
              } else {
                prevPane.style.width = `${nextPrevSize}px`;
                prevPane.style.flex = `0 0 ${nextPrevSize}px`;
              }
              nextPane.style.flex = '1 1 auto';
            }

            function onUp(upEvent) {
              divider.releasePointerCapture(upEvent.pointerId);
              divider.removeEventListener('pointermove', onMove);
              divider.removeEventListener('pointerup', onUp);
              divider.removeEventListener('pointercancel', onUp);
            }

            divider.addEventListener('pointermove', onMove);
            divider.addEventListener('pointerup', onUp);
            divider.addEventListener('pointercancel', onUp);
          });
        });
      }

      function setupPillTabs() {
        document.querySelectorAll('.aqua-tabs-container').forEach((container) => {
          const content = container.querySelector('[data-tab-content]');
          if (!content) return;

          const textByTab = {
            general: 'General settings content goes here.',
            security: 'Security settings content goes here.',
            privacy: 'Privacy settings content goes here.',
          };

          function activate(tabId) {
            container.querySelectorAll('.aqua-tabs .aqua-tab').forEach((btn) => {
              btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
            });
            content.innerHTML = `<p>${textByTab[tabId] || ''}</p>`;
          }

          container.querySelectorAll('.aqua-tabs .aqua-tab').forEach((btn) => {
            btn.addEventListener('click', () => {
              activate(btn.getAttribute('data-tab'));
              btn.blur();
            });
          });
        });
      }

      function setupFolderTabs() {
        document.querySelectorAll('.aqua-folder-tabs').forEach((container) => {
          const tabBar = container.querySelector('.aqua-tab-bar');
          const content = container.querySelector('[data-tab-content]');
          if (!tabBar || !content) return;

          const tabs = tabBar.querySelectorAll('.aqua-tab');

          const textByTab = {
            general: 'General settings content goes here.',
            security: 'Security settings content goes here.',
            privacy: 'Privacy settings content goes here.',
          };

          function activate(tabId) {
            tabs.forEach((t) => {
              t.classList.toggle('aqua-tab--active', t.getAttribute('data-tab') === tabId);
            });
            content.innerHTML = `<p>${textByTab[tabId] || ''}</p>`;
          }

          tabs.forEach((tab) => {
            tab.addEventListener('click', () => {
              activate(tab.getAttribute('data-tab'));
              tab.blur();
            });
          });
        });
      }

      function setupIndeterminateCheckbox() {
        const checkbox = document.getElementById('check-indeterminate');
        if (checkbox) {
          checkbox.indeterminate = true;
        }
      }

      function setupDocTabs() {
        document.querySelectorAll('.doc-tabbed-example').forEach((container) => {
          const tabs = container.querySelectorAll('.aqua-tab[data-doc-tab]');
          const panels = container.querySelectorAll('.aqua-tab-content[data-doc-panel]');

          tabs.forEach((tab) => {
            tab.addEventListener('click', () => {
              const targetId = tab.getAttribute('data-doc-tab');

              tabs.forEach((t) => t.classList.remove('aqua-tab--active'));
              panels.forEach((p) => p.classList.add('hidden'));

              tab.classList.add('aqua-tab--active');
              const targetPanel = container.querySelector(`[data-doc-panel="${targetId}"]`);
              if (targetPanel) targetPanel.classList.remove('hidden');

              tab.blur();
            });
          });
        });
      }

      function setupCopyButtons() {
        document.querySelectorAll('.example .copy').forEach((button) => {
          button.addEventListener('click', () => {
            const example = button.closest('.example');
            const raw = example ? example.querySelector('.raw') : null;
            if (!raw) return;
            const html = raw.innerHTML.trim();

            function setCopied() {
              button.querySelector('span').textContent = 'Copied';
              setTimeout(() => {
                button.querySelector('span').textContent = 'Copy code';
              }, 1200);
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(html).then(setCopied);
            } else {
              const temp = document.createElement('textarea');
              temp.value = html;
              temp.setAttribute('readonly', '');
              temp.style.position = 'absolute';
              temp.style.left = '-9999px';
              document.body.appendChild(temp);
              temp.select();
              document.execCommand('copy');
              document.body.removeChild(temp);
              setCopied();
            }
          });
        });
      }

      function setupAquaEraSelector() {
        const select = document.getElementById('aqua-era-select');
        if (!select) return;

        const body = document.body;
        const valid = new Set(['10-0', '10-2', '10-3', '10-4', '10-6']);
        const storageKey = 'aqua-era';

        function applyEra(value) {
          if (!valid.has(value)) return;
          body.setAttribute('data-aqua-era', value);
          select.value = value;
          try {
            localStorage.setItem(storageKey, value);
          } catch (err) {
            // Ignore storage errors (private mode, blocked, etc.)
          }
        }

        let initial = body.getAttribute('data-aqua-era') || '10-4';
        try {
          const stored = localStorage.getItem(storageKey);
          if (valid.has(stored)) {
            initial = stored;
          }
        } catch (err) {
          // Ignore storage errors (private mode, blocked, etc.)
        }

        applyEra(initial);
        select.addEventListener('change', () => applyEra(select.value));
      }

      // Theme switching for the theme preview section
      window.setTheme = function(theme) {
        // Update both pre-10.6 and 10.6+ preview sections
        const previews = [
          document.getElementById('theme-preview'),
          document.getElementById('theme-preview-pre106')
        ];

        previews.forEach(function(preview) {
          if (preview) {
            preview.className = 'example ' + theme;
          }
        });
      };

      // Unified scrollbar setup - makes all scrollbar thumbs draggable and buttons functional
      function setupScrollbars() {
        document.querySelectorAll('.scrollbar').forEach(function(scrollbar) {
          const isVertical = scrollbar.classList.contains('vertical');
          const track = scrollbar.querySelector('.scrollbar-track');
          const thumb = track ? track.querySelector(isVertical ? '.scrollbar-thumb-v' : '.scrollbar-thumb-h') : null;
          const shimmer = thumb ? thumb.querySelector(isVertical ? '.scrollbar-wave-shimmer-v' : '.scrollbar-wave-shimmer-h') : null;

          if (!thumb || !shimmer || !track) return;

          // Set shimmer size to match track
          if (isVertical) {
            shimmer.style.height = track.offsetHeight + 'px';
          } else {
            shimmer.style.width = track.offsetWidth + 'px';
          }

          // Get current thumb position
          function getThumbPos() {
            if (isVertical) {
              return parseFloat(thumb.style.top) || 20;
            } else {
              return parseFloat(thumb.style.left) || 40;
            }
          }

          // Set thumb position with bounds checking
          function setThumbPos(pos) {
            const trackSize = isVertical ? track.offsetHeight : track.offsetWidth;
            const thumbSize = isVertical ? thumb.offsetHeight : thumb.offsetWidth;
            const maxPos = trackSize - thumbSize;
            const newPos = Math.max(0, Math.min(maxPos, pos));

            if (isVertical) {
              thumb.style.top = newPos + 'px';
            } else {
              thumb.style.left = newPos + 'px';
            }
            updateShimmer();
          }

          // Update shimmer position based on thumb position
          function updateShimmer() {
            if (isVertical) {
              const thumbTop = parseFloat(thumb.style.top) || 20;
              shimmer.style.top = -thumbTop + 'px';
            } else {
              const thumbLeft = parseFloat(thumb.style.left) || 40;
              shimmer.style.left = -thumbLeft + 'px';
            }
          }

          updateShimmer();

          // Button click handling
          const stepSize = 20; // pixels to move per click
          let scrollInterval = null;

          function startScrolling(direction) {
            // Move immediately on first click
            setThumbPos(getThumbPos() + direction * stepSize);
            // Continue scrolling while held
            scrollInterval = setInterval(function() {
              setThumbPos(getThumbPos() + direction * stepSize);
            }, 80);
          }

          function stopScrolling() {
            if (scrollInterval) {
              clearInterval(scrollInterval);
              scrollInterval = null;
            }
          }

          // Find all buttons in this scrollbar
          const buttons = scrollbar.querySelectorAll('button');
          buttons.forEach(function(btn) {
            const title = btn.getAttribute('title') || '';

            // Determine direction based on button title
            let direction = 0;
            if (title.includes('up') || title.includes('left')) {
              direction = -1;
            } else if (title.includes('down') || title.includes('right')) {
              direction = 1;
            }

            if (direction !== 0) {
              btn.addEventListener('mousedown', function(e) {
                startScrolling(direction);
                e.preventDefault();
              });
              btn.addEventListener('mouseup', stopScrolling);
              btn.addEventListener('mouseleave', stopScrolling);
            }
          });

          // Dragging
          let isDragging = false;
          let startPos = 0;
          let startThumbPos = 0;

          thumb.addEventListener('mousedown', function(e) {
            isDragging = true;
            if (isVertical) {
              startPos = e.clientY;
              startThumbPos = parseFloat(thumb.style.top) || 20;
            } else {
              startPos = e.clientX;
              startThumbPos = parseFloat(thumb.style.left) || 40;
            }
            e.preventDefault();
          });

          document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;

            const trackSize = isVertical ? track.offsetHeight : track.offsetWidth;
            const thumbSize = isVertical ? thumb.offsetHeight : thumb.offsetWidth;
            const maxPos = trackSize - thumbSize;

            const delta = isVertical ? e.clientY - startPos : e.clientX - startPos;
            const newPos = Math.max(0, Math.min(maxPos, startThumbPos + delta));

            if (isVertical) {
              thumb.style.top = newPos + 'px';
            } else {
              thumb.style.left = newPos + 'px';
            }

            updateShimmer();
          });

          document.addEventListener('mouseup', function() {
            isDragging = false;
            stopScrolling();
          });
        });
      }

      function setupAquaListbox() {
        const listbox = document.getElementById('aqua-listbox-demo');
        const scrollContent = document.getElementById('aqua-listbox-content');
        const scrollbarTrack = document.getElementById('aqua-listbox-track');
        const scrollbarThumb = document.getElementById('aqua-listbox-thumb');
        const thumbShimmer = document.getElementById('aqua-listbox-shimmer');
        const listboxList = document.getElementById('aqua-listbox-list');

        if (!listbox || !scrollContent || !scrollbarTrack || !scrollbarThumb || !thumbShimmer) return;

        let isDragging = false;
        let startY = 0;
        let startScrollTop = 0;

        function updateScrollbar() {
          const contentHeight = scrollContent.scrollHeight;
          const visibleHeight = scrollContent.clientHeight;
          const scrollTop = scrollContent.scrollTop;
          const trackHeight = scrollbarTrack.clientHeight;

          // Calculate thumb size (proportional to visible content)
          const thumbHeight = Math.max(40, (visibleHeight / contentHeight) * trackHeight);
          scrollbarThumb.style.height = thumbHeight + 'px';

          // Calculate thumb position
          const maxScroll = contentHeight - visibleHeight;
          const maxThumbTop = trackHeight - thumbHeight;
          const thumbTop = maxScroll > 0 ? (scrollTop / maxScroll) * maxThumbTop : 0;
          scrollbarThumb.style.top = thumbTop + 'px';

          // Wave is sized to track height, positioned to stay "fixed" relative to track
          thumbShimmer.style.height = trackHeight + 'px';
          thumbShimmer.style.top = -thumbTop + 'px';
        }

        scrollContent.addEventListener('scroll', updateScrollbar);
        window.addEventListener('resize', updateScrollbar);
        updateScrollbar();

        // Drag functionality
        scrollbarThumb.addEventListener('mousedown', function(e) {
          isDragging = true;
          startY = e.clientY;
          startScrollTop = scrollContent.scrollTop;
          document.body.style.userSelect = 'none';
          e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
          if (!isDragging) return;

          const trackHeight = scrollbarTrack.clientHeight;
          const thumbHeight = scrollbarThumb.clientHeight;
          const contentHeight = scrollContent.scrollHeight;
          const visibleHeight = scrollContent.clientHeight;

          const deltaY = e.clientY - startY;
          const maxThumbTop = trackHeight - thumbHeight;
          const maxScroll = contentHeight - visibleHeight;

          const scrollDelta = (deltaY / maxThumbTop) * maxScroll;
          scrollContent.scrollTop = startScrollTop + scrollDelta;
        });

        document.addEventListener('mouseup', function() {
          if (isDragging) {
            isDragging = false;
            document.body.style.userSelect = '';
          }
        });

        // Click on track to jump
        scrollbarTrack.addEventListener('click', function(e) {
          if (e.target === scrollbarThumb || scrollbarThumb.contains(e.target)) return;

          const trackRect = scrollbarTrack.getBoundingClientRect();
          const clickY = e.clientY - trackRect.top;
          const trackHeight = scrollbarTrack.clientHeight;
          const thumbHeight = scrollbarThumb.clientHeight;
          const contentHeight = scrollContent.scrollHeight;
          const visibleHeight = scrollContent.clientHeight;

          const targetThumbTop = clickY - thumbHeight / 2;
          const maxThumbTop = trackHeight - thumbHeight;
          const maxScroll = contentHeight - visibleHeight;

          const newScrollTop = (targetThumbTop / maxThumbTop) * maxScroll;
          scrollContent.scrollTop = Math.max(0, Math.min(maxScroll, newScrollTop));
        });

        // Arrow button functionality
        const btnUp = document.getElementById('aqua-listbox-btn-up');
        const btnDown = document.getElementById('aqua-listbox-btn-down');
        const scrollStep = 20;
        let scrollInterval = null;

        function startScrolling(direction) {
          scrollContent.scrollTop += direction * scrollStep;
          scrollInterval = setInterval(function() {
            scrollContent.scrollTop += direction * scrollStep;
          }, 50);
        }

        function stopScrolling() {
          if (scrollInterval) {
            clearInterval(scrollInterval);
            scrollInterval = null;
          }
        }

        if (btnUp) {
          btnUp.addEventListener('mousedown', function(e) {
            startScrolling(-1);
            e.preventDefault();
          });
          btnUp.addEventListener('mouseup', stopScrolling);
          btnUp.addEventListener('mouseleave', stopScrolling);
        }

        if (btnDown) {
          btnDown.addEventListener('mousedown', function(e) {
            startScrolling(1);
            e.preventDefault();
          });
          btnDown.addEventListener('mouseup', stopScrolling);
          btnDown.addEventListener('mouseleave', stopScrolling);
        }

        // Item selection functionality
        if (listboxList) {
          listboxList.addEventListener('click', function(e) {
            const item = e.target.closest('.aqua-listbox-item');
            if (!item) return;

            // Remove selected from all items
            listboxList.querySelectorAll('.aqua-listbox-item').forEach(function(li) {
              li.classList.remove('selected');
              li.removeAttribute('aria-selected');
            });

            // Add selected to clicked item
            item.classList.add('selected');
            item.setAttribute('aria-selected', 'true');
          });
        }
      }

      function setupCustomSliders() {
        document.querySelectorAll('.aqua-slider-custom').forEach((slider) => {
          const thumb = slider.querySelector('.thumb');
          const track = slider.querySelector('.track');
          if (!thumb || !track) return;

          const isVertical = slider.classList.contains('vertical');
          const isDisabled = slider.classList.contains('disabled');
          const isDiscrete = slider.classList.contains('discrete');
          if (isDisabled) return;

          // Count ticks for discrete snapping
          const ticks = slider.querySelectorAll('.tick');
          const tickCount = ticks.length > 1 ? ticks.length : 5; // default 5 stops

          let isDragging = false;

          function getPosition(e) {
            const rect = slider.getBoundingClientRect();
            let percent;
            if (isVertical) {
              const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
              percent = clamp((y / rect.height) * 100, 0, 100);
            } else {
              const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
              percent = clamp((x / rect.width) * 100, 0, 100);
            }

            // Snap to nearest tick if discrete
            if (isDiscrete && tickCount > 1) {
              const step = 100 / (tickCount - 1);
              percent = Math.round(percent / step) * step;
            }

            return percent;
          }

          function updateThumb(percent) {
            if (isVertical) {
              thumb.style.top = percent + '%';
            } else {
              thumb.style.left = percent + '%';
            }
          }

          function onStart(e) {
            if (isDisabled) return;
            isDragging = true;
            document.body.style.userSelect = 'none';
            updateThumb(getPosition(e));
            e.preventDefault();
          }

          function onMove(e) {
            if (!isDragging) return;
            updateThumb(getPosition(e));
            e.preventDefault();
          }

          function onEnd() {
            isDragging = false;
            document.body.style.userSelect = '';
          }

          // Mouse events
          thumb.addEventListener('mousedown', onStart);
          slider.addEventListener('mousedown', onStart);
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onEnd);

          // Touch events
          thumb.addEventListener('touchstart', onStart, { passive: false });
          slider.addEventListener('touchstart', onStart, { passive: false });
          document.addEventListener('touchmove', onMove, { passive: false });
          document.addEventListener('touchend', onEnd);
        });
      }

      function setupSpinners() {
        document.querySelectorAll('.aqua-spinner').forEach((spinner) => {
          const input = spinner.querySelector('input');
          const buttons = spinner.querySelectorAll('.aqua-spinner-buttons button');
          if (!input || buttons.length < 2) return;

          const min = parseFloat(input.min) || -Infinity;
          const max = parseFloat(input.max) || Infinity;
          const step = parseFloat(input.step) || 1;

          // Up button (first)
          buttons[0].addEventListener('click', () => {
            const current = parseFloat(input.value) || 0;
            input.value = Math.min(max, current + step);
            input.dispatchEvent(new Event('change'));
          });

          // Down button (second)
          buttons[1].addEventListener('click', () => {
            const current = parseFloat(input.value) || 0;
            input.value = Math.max(min, current - step);
            input.dispatchEvent(new Event('change'));
          });
        });
      }

      // Section navigation with scroll-spy
      function setupSectionNav() {
        const navTabs = document.querySelectorAll('.site-nav-tabs .aqua-tab');
        const sections = document.querySelectorAll('section[data-section-id]');

        if (!navTabs.length || !sections.length) return;

        // Flag to pause scroll-spy during click navigation
        let isScrolling = false;

        // Intersection Observer for scroll-spy
        let currentSection = 'components';

        const observer = new IntersectionObserver((entries) => {
          if (isScrolling) return; // Skip updates during programmatic scroll

          entries.forEach(entry => {
            if (entry.isIntersecting) {
              currentSection = entry.target.dataset.sectionId;
              navTabs.forEach(tab => {
                tab.classList.toggle('aqua-tab--active',
                  tab.dataset.section === currentSection);
              });
            }
          });
        }, {
          threshold: 0,
          rootMargin: '-80px 0px -60% 0px'
        });

        sections.forEach(section => observer.observe(section));

        // Click handlers for tab navigation
        navTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const sectionId = tab.dataset.section;

            // Pause scroll-spy
            isScrolling = true;

            // Immediately activate the clicked tab
            navTabs.forEach(t => {
              t.classList.toggle('aqua-tab--active', t.dataset.section === sectionId);
            });

            const target = document.querySelector(`section[data-section-id="${sectionId}"]`);
            if (target) {
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });

              // Re-enable scroll-spy after animation completes
              setTimeout(() => {
                isScrolling = false;
              }, 800);
            }
            tab.blur();
          });
        });
      }

      // Sidebar toggle for mobile
      function setupSidebarToggle() {
        const toggle = document.querySelector('.sidebar-toggle');
        const sidebar = document.querySelector('.sidebar');

        if (!toggle || !sidebar) return;

        toggle.addEventListener('click', () => {
          toggle.classList.toggle('is-active');
          sidebar.classList.toggle('is-open');
        });

        // Close sidebar when clicking a link
        sidebar.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            toggle.classList.remove('is-active');
            sidebar.classList.remove('is-open');
          });
        });
      }

      setupTitledPanes();
      setupTreeTable();
      setupSplitPanes();
      setupPillTabs();
      setupFolderTabs();
      setupDocTabs();
      setupIndeterminateCheckbox();
      setupCopyButtons();
      setupAquaEraSelector();
      setupScrollbars();
      setupAquaListbox();
      setupCustomSliders();
      setupSpinners();
      setupSectionNav();
      setupSidebarToggle();
    })();
  </script>
